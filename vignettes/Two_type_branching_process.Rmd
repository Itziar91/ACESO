---
title: "One drug resistance mechanisms"
author: "Itziar Irurzun Arana"
date: "`r Sys.Date()`"
output:  
  prettydoc::html_pretty:
    theme: cayman 
    highlight: github
vignette: >
  %\VignetteIndexEntry{Complex dosing schedules}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  warnings= FALSE
)
```
Load library:
```{r}
library(ACESO)
```
### Read cell proliferation file:

Use **read.cellcount.data** function to create a data.frame with the info about cell proliferation under different drug concentrations.

Mandatory columns to be in the .csv file: 

* Viable.cells: cell count data
* Time: time point
* CONC: drug concentration

Optional columns: 

* Replicate: Technical replicate. If missing the program assumes that there is only 1 replicate.
* Cell.line: Name of the cell line. If missing the fucntion introduces the name 'Cell line 1'
* Type: numerical column specifiying the cell type (0: sensitive cells, 1: resistant cell to drug A, etc.). If missing the program assumes Type=0.

```{r}
growth_data=read.cellcount.data(system.file("extdata", "cell_viability_assay.txt", package = "ACESO"), sep=";")
head(growth_data)
```
Two new columns are created from the csv file:

* Cell_Count_0: cell count at time 0.
* Control: cell count when there is no drug concentration


```{r}
#Exploraty plot:  viable cells over time
library(ggplot2)
ggplot(data=growth_data,aes(x=Time,y=Viable.cells,col=factor(CONC)))+geom_point()+
  geom_smooth(se=F)+facet_wrap(~Type)
```

### Read cell death file:

Call **read.celldeath.file** to create a data.frame with the info about the total count of dead cells under different drug concentrations.

Necessary columns to be in the .csv file: 

* Time: time point
* Annexin.Vplus or Dead.cells: 'Annexin.Vplus' describes the franction of dead cells and 'Dead.cells' the total count of dead cells. At least one of these columns is mandatory.
* CONC: drug concentration
```{r}
cell_death=read.celldeath.file(system.file("extdata", "apoptosis_assay.txt", package = "ACESO"), column.name="Apoptotic.fraction",sep=";")
head(cell_death)
```
Exploratory plot:
```{r}
library(dplyr)
my_sum <- cell_death %>%
  group_by(CONC,Time,Type2) %>%
  summarise(
    n=n(),
    mean=mean(Apoptotic.fraction),
    sd=sd(Apoptotic.fraction)
  )

ggplot(cell_death[cell_death$Time!=0,])+
  geom_bar(data=my_sum[my_sum$Time!=0,],aes(x=as.factor(Time), y=mean,fill=as.factor(CONC),color=as.factor(CONC)), stat="identity", alpha=0.7, position=position_dodge(0.9)) +
  geom_jitter(aes(x=as.factor(Time), y=Apoptotic.fraction,color=as.factor(CONC)), size=0.9, position=position_dodge(0.9))+
  facet_wrap(~factor(Type2,levels=c("sensitive","resistant")))+
  xlab("Time (hours)")+ylab("Fraction of death cells")+
  geom_errorbar(data=my_sum[my_sum$Time!=0,], aes(x=as.factor(Time), ymin=mean-sd, ymax=mean+sd,color=as.factor(CONC)),width=.2, position=position_dodge(0.9))+
  theme_bw()+ggsci::scale_color_jco(name="Erlotinib concentration (µM)")+ggsci::scale_fill_jco(name="Erlotinib concentration (µM)")+
  theme(text = element_text(size=14))+theme(legend.position="top") 
```
### Calculate net growth rate from cell proliferation data:
We assume an exponential growth to calculate the net growth rate and decided not to use the data corresponding to time = 0 to calculate those rates:
```{r}
growth_data<-net_growth_rate(growth_data,time0_data = T)
head(growth_data) #See the values in Net_growth column
```
### Calculate death rate:
Use the data from cell apoptosis assays and the data where the net growth rate parameters have been calculated  to compute the death rate parameter. Call **calculate_death_rate** for this purpose.
```{r}
all.data=calculate_death_rate(net_growth_data=growth_data,cell_death_data =cell_death, column.name = "Apoptotic.fraction")
```

Plot the resulting death and birth rates:
```{r}
ggplot(all.data,aes(x=CONC,y=Death_rate))+geom_point()+scale_y_continuous(limits = c(0, 0.05))+facet_wrap(~Type)

ggplot(all.data,aes(x=CONC,y=Birth_rate))+geom_point()+facet_wrap(~Type)
```

## Fit the curves
Call  **Multiple.best.singlefit** function to fit the concentration-response curves. 
In this example we only have data from one cell.line (PC-9), but this function is able to fit multiple cell lines.

To perform this task easily and faster, we included the flexible and built-in model functions of the drc R package. drc was developed to provide nonlinear model fitting for dose-response analysis and it already includes the most common function to fit this type of curves. To see all the different built-in functions included in the package write: drc::getMeanFunctions().  **Multiple.best.singlefit** tries all the different models of drc library and selects the best one for you based on AIC or BIC (by default AIC is used).

```{r}
BR.fit=Multiple.best.singlefit(all.data,resp="Birth_rate")
BR.fit
DR.fit=Multiple.best.singlefit(all.data,resp="Death_rate")
DR.fit
```